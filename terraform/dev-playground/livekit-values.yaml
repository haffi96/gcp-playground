# LiveKit Server Configuration for GKE
# Based on official LiveKit Helm chart

replicaCount: 1

image:
  repository: livekit/livekit-server
  tag: "v${livekit_version}"
  pullPolicy: IfNotPresent

# LiveKit configuration
livekit:
  # Number of CPU cores available (used for load balancing)
  num_cpus: 2
  
  # API Keys for authentication
  keys:
    ${livekit_api_key}: ${livekit_api_secret}
  
  # Redis configuration for distributed setup
  redis:
    address: ${redis_host}:${redis_port}

  # RTC configuration
  rtc:
    # Port range for WebRTC
    port_range_start: 50000
    port_range_end: 50200
    # Use external IP for WebRTC candidates
    use_external_ip: true
    
    # Enable UDP for better performance
    # udp_port: 7882
    tcp_port: 7881
    
  # Room settings
  room:
    # Enable auto-create rooms
    auto_create: true
    # Max participants per room
    max_participants: 100
    # Room timeout (seconds before closing empty room)
    empty_timeout: 300
    
  # Logging
  logging:
    level: info
    # Enable detailed WebRTC logs for debugging (disable in production)
    pion_level: warning
  
  # TLS/SSL configuration
  # Certificates provided by cert-manager
  tls:
    enabled: true
    cert_file: /etc/livekit-tls/tls.crt
    key_file: /etc/livekit-tls/tls.key
    
  # TURN server configuration with TLS (for NAT traversal)
  turn:
    enabled: true
    domain: ${domain}
    # Use TLS for TURN on port 443 (firewall-friendly)
    tls_port: 5349
    udp_port: 3478
    external_tls: true

# Deployment strategy
deploymentStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# Service configuration
service:
  type: LoadBalancer
  annotations:
    # Use internal load balancer if needed
    # cloud.google.com/load-balancer-type: "Internal"
  
  # HTTPS/WebSocket port
  http:
    enabled: true
    port: 443
    targetPort: 7880
    protocol: TCP
  
  # HTTP redirect (optional)
  httpRedirect:
    enabled: true
    port: 80
    targetPort: 7880
    protocol: TCP
  
  # RTC ports (UDP/TCP)
  rtc:
    enabled: true
    # UDP port range for WebRTC media
    portRangeStart: 50000
    portRangeEnd: 50200
    
  # TURN server ports
  turn:
    enabled: true
    # TURN over TLS (firewall-friendly)
    tlsPort: 5349
    # TURN over UDP
    udpPort: 3478

# Enable host networking for direct port access
# This is CRITICAL for LiveKit WebRTC to work properly
hostNetwork: true
dnsPolicy: ClusterFirstWithHostNet

# Termination grace period (allow 5 hours for graceful shutdown)
terminationGracePeriodSeconds: 18000

# Node selector - ensure pods run on dedicated LiveKit nodes
nodeSelector:
  workload: livekit

# Resources
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /
    port: 7880
    scheme: HTTP
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /
    port: 7880
    scheme: HTTP
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 2

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod security context
podSecurityContext:
  runAsNonRoot: false
  runAsUser: 0
  fsGroup: 0

securityContext:
  capabilities:
    add:
      - NET_BIND_SERVICE
      - SYS_RESOURCE
  allowPrivilegeEscalation: false

# Affinity - ensure pods don't co-locate (one per node for host networking)
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - livekit-server
        topologyKey: kubernetes.io/hostname

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 0

# Autoscaling (disabled for playground)
autoscaling:
  enabled: false

# Ingress - disable since we're using LoadBalancer directly
ingress:
  enabled: false

# Monitoring (optional)
serviceMonitor:
  enabled: false

# Volume mounts for TLS certificates from cert-manager
extraVolumes:
  - name: livekit-tls
    secret:
      secretName: livekit-tls-secret
      defaultMode: 0644

extraVolumeMounts:
  - name: livekit-tls
    mountPath: /etc/livekit-tls
    readOnly: true
